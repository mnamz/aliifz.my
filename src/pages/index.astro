---
import { type CollectionEntry } from "astro:content";
import PostPreview from "@/components/blog/PostPreview.astro";
import SocialList from "@/components/SocialList.astro";
import { getAllPosts } from "@/data/post";
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort } from "@/utils/date";

// Posts
const MAX_POSTS = 10;
const allPosts = await getAllPosts();
const allPostsByDate = allPosts.sort(collectionDateSort) as CollectionEntry<"post">[];
const latestPosts = allPostsByDate.slice(0, MAX_POSTS);

// Pinned Posts, set to a max of 3;
const MAX_PINNED_POSTS = 3;
const pinnedPosts = allPostsByDate.filter((p) => p.data.pinned).slice(0, MAX_PINNED_POSTS);

function getExcerpt(body: string | undefined, maxLength = 160): string {
	if (!body) return "";
	const plain = body
		.replace(/^---[\s\S]*?---/, "")
		.replace(/^#{1,6}\s+.*$/gm, "")
		.replace(/\[([^\]]*)\]\([^)]*\)/g, "$1")
		.replace(/[*_~`>#\-]/g, "")
		.replace(/\n+/g, " ")
		.trim();
	return plain.length > maxLength ? plain.slice(0, maxLength).trimEnd() + "â€¦" : plain;
}
---

<PageLayout meta={{ title: "Home" }}>
	<section>
		<h1 class="title mb-12">Hi, I'm Aliif</h1>
		<p class="mb-4">
			Problem solver, system integrator based in Malaysia. I write about everything I find interesting, whether about my work or daily pondering.
		</p>
		<SocialList />
	</section>
	{
		pinnedPosts.length > 0 && (
			<section class="mt-16">
				<h2 class="title mb-6 text-xl">Pinned Posts</h2>
				<ul class="space-y-4" role="list">
					{pinnedPosts.map((p) => (
						<li class="grid gap-1 sm:grid-cols-[auto_1fr]">
							<PostPreview post={p} />
							{getExcerpt(p.body) && (
								<p class="text-muted-foreground col-start-2 text-sm text-gray-500 dark:text-gray-400 line-clamp-2">
									{getExcerpt(p.body)}
								</p>
							)}
						</li>
					))}
				</ul>
			</section>
		)
	}
	<section class="mt-16">
		<h2 class="title text-accent mb-6 text-xl"><a href="/posts/">Posts</a></h2>
		<ul class="space-y-4" role="list">
			{
				latestPosts.map((p) => (
					<li class="grid gap-1 sm:grid-cols-[auto_1fr]">
						<PostPreview post={p} />
					</li>
				))
			}
		</ul>
	</section>
</PageLayout>
